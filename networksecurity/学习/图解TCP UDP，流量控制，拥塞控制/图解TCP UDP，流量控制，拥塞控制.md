# 图解 TCP / UDP，流量控制，拥塞控制！



### 一、TCP

TCP首部
流量控制
拥塞控制
三次握手，四次挥手
tcp 怎样保证数据正确性？

流量控制是为了让接收方能来得及接收，而拥塞控制是为了降低整个网络的拥塞程度

#### 1、TCP首部

![1](.\images\1.png)

源端口号
目标端口号
32位序列号
32位确认号
首部长度（单位为4字节，默认为5，即20字节）
保留位（6位）

6个控制位（SYN、ACK、FIN、PUSH、URG、RST） SYN：同步序号位，TCP建立连接时要将这个值设为1 ACK：为1表示确认号 FIN：发送端完成位，提出断开连接的一方把FIN置为1表示要断开连接 PUSH：急迫位，缓存区将满，立刻传输速度 RST：重置位，连接断了重新连接 URG：紧急信号

16位窗口大小：接收窗口大小，流量控制使用，如果窗口大小为0，可以发送窗口探测

16位校验和：校验和用来做差错控制，TCP校验和的计算包括TCP首部、数据和其它填充字节。在发送TCP数据段时，由发送端计算校验和，当到达目的地时又进行一次检验和计算。如果两次校验和一致，说明数据是正确的，否则将认为数据被破坏，接收端将丢弃该数据

16位紧急指针：仅在URG控制位为 1 时有效。表示紧急数据的末尾在 TCP 数据部分中的位置。通常在暂时中断通信时使用（比如输入 Ctrl + C）

#### 2、流量控制

![2](.\images\2.png)

流量控制，就是让发送方的发送速率不要太快，要让接收方来得及接收

利用滑动窗口机制可以很方便地在tcp连接上实现对发送方的流量控制

TCP接收方利用自己的接收窗口的大小来限制发送方发送窗口的大小

重传计时器

TCP发送方收到接收方的零窗口通知后，应启动持续计时器。持续计时器超时后，向接收方发送零窗口探测报文

即使接收窗口为0，接收方也会接收：零窗口探测报文段、确认报文段、携带紧急数据的报文段

TCP发送方的发送窗口大小 = Math.min(自身拥塞窗口大小, TCP接收方的接收窗口大小)

#### 3、拥塞控制

什么是拥塞

![3](.\images\3.png)

假定条件

数据是单方向发送，而另一方向只传送确认 接收方总是有足够大的缓存空间，因而发送方发送窗口的大小由网络的拥塞程度来决定 以最大报文段MSS的个数为讨论问题的单位，而不是以字节为单位

慢开始 + 拥塞避免算法

MSS：TCP最大报文段 ssthresh：慢开始门限 cwnd：拥塞窗口 swnd：发送窗口 rtt：每次往返时间

![4](.\images\4.png)

快重传

![5](.\images\5.png)

慢开始 + 拥塞避免算法中，发送方把拥塞窗口cwnd又设置为1，并错误地启动慢开始算法，降低了传输效率

![6](.\images\6.png)

收到3个重复确认

接收方收到失序的报文段，立即发出重复确认

发送方收到3个连续的重复确认，立即重传

![7](.\images\7.png)

快恢复

![8](.\images\8.png)

慢开始 + 拥塞避免+快重传 + 快恢复结合

![9](.\images\9.png)

#### 4、三次握手，四次挥手

**4.1 三次握手**

发送端：SYN=1、seq=x
接收端：ACK=1、ack=x+1、SYN=1、seq=y
发送端：ACK=1、ack=y+1、seq=x+1

TCP规定：SYN被设置为1的报文段不能携带数据，但要消耗掉一个序号
TCP规定：普通的确认报文段如果不携带数据，则不消耗序号

![10](.\images\10.png)



**4.2 四次挥手**

发送端：FIN=1，ACK=1，seq=u，ack=v（u等于发送端已传送过的数据的最后一个字节序号+1，v等于发送端之前已收到的数据的最后一字节序号+1）
接收端：ACK=1，ack=u+1，seq=v
接收端：FIN=1，ACK=1，ack=u+1，seq=w（w：半关闭情况下，可能收到了数据）
发送端：ACK=1，ack=w+1，seq=u+1

TCP规定：终止位FIN等于1的报文段，即使不携带数据，也要一个消耗掉一个序号
MSL：最长报文段寿命，建议为2分钟

为什么要等待2MSL？

如果接收端发送FIN连接释放，发送端接收后发送ACK，如果丢失，会导致接收端超时重传，而无法进入CLOSED状态

![11](.\images\11.png)

**4.3 保活计时器**

![12](.\images\12.png)

**4.4 半连接队列**

服务器第一次收到客户端的 SYN 之后，就会处于 SYN_RCVD 状态，此时双方还没有完全建立其连接，服务器会把此种状态下请求连接放在一个队列里，我们把这种队列称之为半连接队列。

**4.5 三次握手能不能改成两次握手？**

不能

TCP发送连接请求，但长时间没到达，然后触发了超时重传

又发送了一次，后建立连接，数据传输，并断开了连接

但此时之前没达到的请求报文段突然又到了接收端服务器，接收端服务器变成了ESTABLISHED状态

接收端一直在等发送端发送数据，白白浪费了主机很多资源，导致了错误

![13](.\images\13.png)

**4.6 四次挥手能不能改成三次挥手？**

不能

接收端可能还有数据没有发送

需要等待一段时间，发送完数据，才会发送FIN

**4.7 SYN攻击**

服务器端的资源分配是在二次握手时分配的，而客户端的资源是在完成三次握手时分配的，所以服务器容易受到SYN洪泛攻击。SYN攻击就是Client在短时间内伪造大量不存在的IP地址，并向Server不断地发送SYN包，Server则回复确认包，并等待Client确认，由于源地址不存在，因此Server需要不断重发直至超时，这些伪造的SYN包将长时间占用未连接队列，导致正常的SYN请求因为队列满而被丢弃，从而引起网络拥塞甚至系统瘫痪。SYN 攻击是一种典型的 DoS/DDoS 攻击。

#### 5、tcp 怎样保证数据正确性？

差错控制 发送的数据包的二进制相加然后取反，检测数据在传输过程中的任何变化，如果收到段的检验和有差错，TCP 将丢弃这个报文段和不确认收到此报文段。编号 + 排序 TCP 给发送的每一个包进行编号，接收方对数据包进行排序，把有序数据传送给应用层 确认 + 超时重传的机制 当 TCP 发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到一个确认，将重发这个报文段。流量控制

TCP 连接的每一方都有固定大小的缓冲空间，TCP 的接收端只允许发送端发送接收端缓存区能接纳的数据。当接收方来不及处理发送方的数据，能提示发送方降低发送的速率，防止包丢失。TCP 使用的流量控制协议是可变大小的滑动窗口协议。

拥塞控制

当网络拥塞时，减少数据的发送。发送方有拥塞窗口，发送数据前比对接收方发过来的接收窗口，取两者的最小值---慢启动、拥塞避免、拥塞发送、快速恢复。另外，搜索公众号Linux就该这样学后台回复“电子书”，获取一份惊喜礼包。

### 二、UDP

![14](.\images\14.png)

### 三、TCP/UDP对比

TCP/IP协议架构

![15](.\images\15.png)

对比

![16](.\images\16.png)

**1、是否面向连接**

UDP：无连接
TCP：面向连接（三次握手，四次挥手）

![17](.\images\17.png)

**2、是否支持广播和多播**

UDP：支持一对一，一对多，多对一和多对多交互通信
TCP：只能一对一通信

![18](.\images\18.png)

**3、对应用层报文的处理**

UDP：面向报文（对应用层交付的报文直接打包）
TCP：面向字节流（是tcp实现可靠传输，流量控制，拥塞控制的基础）

![19](.\images\19.png)

**4、是否提供可靠传输**

UDP：向上提供无连接不可靠服务
UDP：适用于实时应用（IP电话、视频会议等）
TCP：向上提供面向连接的可靠服务
TCP：适用于要求可靠传输的应用，例如文件传输

![20](.\images\20.png)

**5、首部开销**

UDP：8个字节
TCP：最小20字节，最大60字节

![21](.\images\21.png)